name: OBS:Staging (rubygem-agama)

on:
  # runs on pushes targeting the default branch
  push:
    branches:
      - master
      # FIXME: remove this before merging
      - obs_sync
    # FIXME: enable before merging
    # paths:
    #   # run only when a service source is changed
    #   # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#filter-pattern-cheat-sheet
    #   - service/**

jobs:
  update_staging:
    # do not run in forks
    if: github.repository == 'openSUSE/agama'

    runs-on: ubuntu-latest

    container:
      image: registry.opensuse.org/opensuse/tumbleweed:latest

    steps:
      - name: Configure and refresh repositories
        # disable unused repositories to have a faster refresh
        run: zypper modifyrepo -d repo-non-oss repo-openh264 repo-update && zypper ref

      - name: Install tools
        run: zypper --non-interactive install --no-recommends
             git
             osc
             ruby
             'rubygem(gem2rpm)'

      - name: Git Checkout
        uses: actions/checkout@v3
        with:
          # fetch all history, we need to find the latest tag and offset for the version number
          fetch-depth: 0

      - name: Fix file owner
        run: chown -R -c 0 .

      - name: Generate version number
        # the version is <version_tag>.devel<number_of_commits_since_the_tag>
        # or just <version_tag> if there are no additional commits
        run: |-
          git describe --tags | sed -e 's/-\([0-9]*\)-g[a-fA-F0-9]*$/.devel\1/' -e 's/^v//' > VERSION
          echo -n "Version: "
          cat VERSION
        working-directory: ./service

      - name: Update agma rubygem
        run: gem build agama.gemspec
        working-directory: ./service

      - name: Generate RPM spec file
        run: gem2rpm --local --config package/gem2rpm.yml agama-*.gem > package/rubygem-agama.spec
        working-directory: ./service

      - name: Configure osc
        run: |-
          CONFIG_FILE="$HOME/.config/osc/oscrc"
          mkdir -p $(dirname "$CONFIG_FILE")
          echo "$TEMPLATE" > "$CONFIG_FILE"
        env:
          TEMPLATE: |-
            [general]
            apiurl = https://api.opensuse.org

            [https://api.opensuse.org]
            user=${{ secrets.OBS_USER }}
            pass=${{ secrets.OBS_PASSWORD }}
            credentials_mgr_class=osc.credentials.PlaintextConfigFileCredentialsManager

      - name: Checkout rubygem-agama
        run: osc co systemsmanagement:Agama:Staging rubygem-agama

      - name: Update files
        run: |-
            rm ./systemsmanagement:Agama:Staging/rubygem-agama/*
            cp service/agama-*.gem service/package/* ./systemsmanagement:Agama:Staging/rubygem-agama

      - name: Check rubygem-agama
        run: osc addremove && osc status
        working-directory: ./systemsmanagement:Agama:Staging/rubygem-agama

      - name: Commit rubygem-agama
        run: osc commit -m "Updating to $(cat ../../service/VERSION) ($GITHUB_SHA)"
        working-directory: ./systemsmanagement:Agama:Staging/rubygem-agama
