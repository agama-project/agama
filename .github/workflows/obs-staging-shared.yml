name: Update OBS Staging

on:
  workflow_call:
    secrets:
      OBS_USER:
        required: true
      OBS_PASSWORD:
        required: true

    inputs:
      install_packages:
        description: Additional packages to install
        required: false
        type: string

      package_name:
          description: OBS package name
          required: true
          type: string

jobs:
  update_staging_package:
    # do not run in forks
    if: github.repository == 'openSUSE/agama'

    runs-on: ubuntu-latest

    container:
      image: registry.opensuse.org/opensuse/tumbleweed:latest

    steps:
      - name: Configure and refresh repositories
        # disable unused repositories to have a faster refresh
        run: zypper modifyrepo -d repo-non-oss repo-openh264 repo-update && zypper ref

      - name: Install tools
        run: zypper --non-interactive install --no-recommends
             cpio
             obs-service-download_files
             obs-service-format_spec_file
             obs-service-obs_scm
             osc
             ${{ inputs.install_packages }}

      - name: Configure osc
        run: |-
          CONFIG_FILE="$HOME/.config/osc/oscrc"
          mkdir -p $(dirname "$CONFIG_FILE")
          echo "$TEMPLATE" > "$CONFIG_FILE"
        env:
          TEMPLATE: |-
            [general]
            apiurl = https://api.opensuse.org

            [https://api.opensuse.org]
            user=${{ secrets.OBS_USER }}
            pass=${{ secrets.OBS_PASSWORD }}
            credentials_mgr_class=osc.credentials.PlaintextConfigFileCredentialsManager

      - name: Checkout ${{ inputs.package_name }}
        run: osc co systemsmanagement:Agama:Staging ${{ inputs.package_name }}
  
      - name: Update ${{ inputs.package_name }}
        run: osc service manualrun
        working-directory: ./systemsmanagement:Agama:Staging/${{ inputs.package_name }}

      - name: Check ${{ inputs.package_name }}
        run: osc status
        working-directory: ./systemsmanagement:Agama:Staging/${{ inputs.package_name }}

      - name: Commit ${{ inputs.package_name }}
        run: |-
          osc commit -m "Updated to $(sed -e '/^version:/!d' -e 's/version: *\(.*\)/\1/' agama.obsinfo) ($(sed -e '/^commit:/!d' -e 's/commit: *\(.*\)/\1/' agama.obsinfo))"
        working-directory: ./systemsmanagement:Agama:Staging/${{ inputs.package_name }}
